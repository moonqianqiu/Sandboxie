name: Build Sandboxie - Enhanced
on:
push:
branches: [ master, main, develop ]
pull_request:
branches: [ master, main ]
workflow_dispatch:
inputs:
architecture:
description: 'Build architecture'
required: true
default: 'x64'
type: choice
options:
- x64
- Win32
- ARM64
qt_version:
description: 'Qt version'
required: true
default: '6.8.3'
type: choice
options:
- '6.8.3'
- '6.7.2'
- '6.6.0'
- '5.15.16'
env:
DEVELOPER_DIR: "/Applications/Xcode.app/Contents/Developer"
jobs:
# =================================================================
# Windowsæž„å»ºä½œä¸š - ä½¿ç”¨nmakeæ›¿ä»£jom
# =================================================================
build-windows:
runs-on: windows-latest
timeout-minutes: 60
strategy:
fail-fast: false
matrix:
include:
- arch: x64
qt_version: 6.8.3
visual_studio: vs2022
- arch: Win32  
qt_version: 6.8.3
visual_studio: vs2022
- arch: x64
qt_version: 5.15.16
visual_studio: vs2022
steps:
# =================================================================
# 1. æ£€å‡ºä»£ç 
# =================================================================
- name: Checkout repository
uses: actions/checkout@v4
with:
fetch-depth: 0
path: sandboxie-project
# =================================================================
# 2. è®¾ç½®Visual StudioçŽ¯å¢ƒ
# =================================================================
- name: Setup Visual Studio
uses: microsoft/setup-msbuild@v2
with:
msbuild-version: '17.11'
# =================================================================
# 3. å®‰è£…QtçŽ¯å¢ƒï¼ˆä½¿ç”¨å®˜æ–¹actionï¼‰
# =================================================================
- name: Install Qt
uses: jurplel/install-qt-action@v4
with:
version: ${{ matrix.qt_version }}
host: windows
target: desktop
arch: ${{ matrix.arch }}
cache: true
cache-key-prefix: 'qt-${{ matrix.arch }}-${{ matrix.qt_version }}'
# =================================================================
# 4. è®¾ç½®æž„å»ºçŽ¯å¢ƒå˜é‡
# =================================================================
- name: Configure build environment
shell: cmd
run: |
echo Configuring build environment for ${{ matrix.arch }}...
REM è®¾ç½®æž¶æž„ç‰¹å®šå˜é‡
if "${{ matrix.arch }}"=="x64" (
set QT_ARCH=x64
set MSVC_ARCH=64
set BUILD_SUFFIX=_x64
) else if "${{ matrix.arch }}"=="Win32" (
set QT_ARCH=Win32
set MSVC_ARCH=32
set BUILD_SUFFIX=_Win32
) else (
set QT_ARCH=ARM64
set MSVC_ARCH=arm64
set BUILD_SUFFIX=_ARM64
)
REM æ¿€æ´»Visual StudioçŽ¯å¢ƒ
if "${{ matrix.arch }}"=="Win32" (
call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
) else (
call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
)
REM éªŒè¯å·¥å…·é“¾
where qmake
where nmake
echo Build environment configured successfully
# =================================================================
# 5. åˆ›å»ºä¿®å¤çš„æž„å»ºè„šæœ¬
# =================================================================
- name: Create fixed build script
shell: cmd
run: |
cd sandboxie-project\SandboxiePlus
REM åˆ›å»ºå¤‡ä»½
if exist qmake_plus.cmd.backup (
echo Backup already exists
) else (
copy qmake_plus.cmd qmake_plus.cmd.backup
echo Original file backed up
)
REM åº”ç”¨ä¿®å¤ï¼šæ›¿æ¢jomä¸ºnmake
powershell -Command ^
"(Get-Content 'qmake_plus.cmd') -replace 'jom\.exe\s+-f\s+Makefile\.(\w+)\s+-j\s+\d+', 'nmake -f Makefile.$1 -j 4' | Set-Content 'qmake_plus.cmd'"
powershell -Command ^
"(Get-Content 'qmake_plus.cmd') -replace 'jom\.exe', 'nmake' | Set-Content 'qmake_plus.cmd'"
REM éªŒè¯ä¿®å¤ç»“æžœ
findstr /C:"nmake" qmake_plus.cmd >nul
if errorlevel 1 (
echo ERROR: Failed to apply build tool fix
exit /b 1
)
echo Build script fixed successfully
# =================================================================
# 6. æ‰§è¡Œæž„å»ºï¼ˆä½¿ç”¨ä¿®å¤åŽçš„è„šæœ¬ï¼‰
# =================================================================
- name: Build Sandboxie components
shell: cmd
run: |
echo Starting build process...
cd sandboxie-project\SandboxiePlus
REM æ‰§è¡Œæž„å»º
call qmake_plus.cmd ${{ matrix.arch }}
REM æ£€æŸ¥æž„å»ºç»“æžœ
if exist "Build_UGlobalHotkey_%BUILD_SUFFIX%\UGlobalHotkey.dll" (
echo âœ… UGlobalHotkey built successfully
) else (
echo âŒ UGlobalHotkey build failed
dir Build_UGlobalHotkey_%BUILD_SUFFIX%\*.log
exit /b 1
)
if exist "Build_QSbieAPI_%BUILD_SUFFIX%\QSbieAPI.dll" (
echo âœ… QSbieAPI built successfully
) else (
echo âŒ QSbieAPI build failed
dir Build_QSbieAPI_%BUILD_SUFFIX%\*.log
exit /b 1
)
if exist "Build_SandMan_%BUILD_SUFFIX%\SandMan.exe" (
echo âœ… SandMan built successfully
) else (
echo âŒ SandMan build failed
dir Build_SandMan_%BUILD_SUFFIX%\*.log
exit /b 1
)
echo Build completed successfully!
# =================================================================
# 7. æ”¶é›†æž„å»ºäº§ç‰©
# =================================================================
- name: Collect build artifacts
shell: cmd
run: |
echo Collecting build artifacts...
cd sandboxie-project\SandboxiePlus
REM å¤åˆ¶å…³é”®æ–‡ä»¶åˆ°artifactç›®å½•
mkdir artifact
xcopy /E /I /Y bin\%BUILD_SUFFIX% artifact\bin
xcopy /E /I /Y "Build_UGlobalHotkey_%BUILD_SUFFIX%\*.dll" artifact
xcopy /E /I /Y "Build_QSbieAPI_%BUILD_SUFFIX%\*.dll" artifact
xcopy /E /I /Y "Build_SandMan_%BUILD_SUFFIX%\*.exe" artifact
REM åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
echo Sandboxie Build Information > artifact\build-info.txt
echo Architecture: %BUILD_SUFFIX% >> artifact\build-info.txt
echo Qt Version: ${{ matrix.qt_version }} >> artifact\build-info.txt
echo Build Date: %date% %time% >> artifact\build-info.txt
echo Git Commit: %%GITHUB_SHA%% >> artifact\build-info.txt
echo Build Version: Enhanced CI Build >> artifact\build-info.txt
dir artifact
# =================================================================
# 8. ä¸Šä¼ æž„å»ºäº§ç‰©
# =================================================================
- name: Upload build artifacts
uses: actions/upload-artifact@v4
with:
name: Sandboxie-${{ matrix.arch }}-${{ matrix.qt_version }}-Enhanced
path: sandboxie-project/SandboxiePlus/artifact/*
retention-days: 30
if-no-files-found: error
# =================================================================
# 9. ä¸Šä¼ æž„å»ºæ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
# =================================================================
- name: Upload build logs on failure
if: failure()
uses: actions/upload-artifact@v4
with:
name: Build-Logs-${{ matrix.arch }}-${{ matrix.qt_version }}-Enhanced
path: |
sandboxie-project/SandboxiePlus/Build_*/
sandboxie-project/SandboxiePlus/*.log
sandboxie-project/SandboxiePlus/*.err
retention-days: 7
# =================================================================
# 10. æž„å»ºçŠ¶æ€é€šçŸ¥
# =================================================================
- name: Notify build status
if: always()
run: |
if "${{ job.status }}"=="success" (
echo "ðŸŽ‰ Build completed successfully for ${{ matrix.arch }}"
) else (
echo "âŒ Build failed for ${{ matrix.arch }}"
echo "Check the logs for more details"
)
# =================================================================
# ä½œä¸šé—´ä¾èµ–å’Œæ•°æ®ä¼ é€’
# =================================================================
combine-artifacts:
needs: build-windows
runs-on: ubuntu-latest
if: always() && (contains(needs.*.result, 'success'))
steps:
- name: Download all artifacts
uses: actions/download-artifact@v4
with:
path: artifacts
- name: Combine build results
run: |
echo "ðŸ“¦ Combining build artifacts..."
ls -la artifacts/
# åˆ›å»ºæ±‡æ€»æŠ¥å‘Š
echo "# Sandboxie Enhanced CI Build Report" > build-summary.md
echo "" >> build-summary.md
echo "**Build Date:** $(date)" >> build-summary.md
echo "**Trigger:** ${{ github.event_name }}" >> build-summary.md
echo "**Commit:** ${{ github.sha }}" >> build-summary.md
echo "" >> build-summary.md
echo "## Build Results" >> build-summary.md
for artifact_dir in artifacts/*/; do
echo "- âœ… $(basename "$artifact_dir")" >> build-summary.md
done
echo "" >> build-summary.md
echo "## Build Environment" >> build-summary.md
echo "- **OS:** Windows Latest" >> build-summary.md
echo "- **Qt Versions:** 5.15.16, 6.8.3" >> build-summary.md
echo "- **Architectures:** x64, Win32" >> build-summary.md
echo "- **Build Tool:** nmake (replaced jom)" >> build-summary.md
echo "- **Visual Studio:** 2022 Enterprise" >> build-summary.md
- name: Upload build summary
uses: actions/upload-artifact@v4
with:
name: Build-Summary-Enhanced
path: build-summary.md
# =================================================================
# ä»£ç è´¨é‡æ£€æŸ¥
# =================================================================
code-quality:
needs: build-windows
runs-on: ubuntu-latest
if: github.event_name == 'push' && github.ref == 'refs/heads/main'
steps:
- name: Checkout repository
uses: actions/checkout@v4
with:
fetch-depth: 0
- name: Download artifacts
uses: actions/download-artifact@v4
with:
path: artifacts
- name: Quality analysis
run: |
echo "ðŸ” Performing code quality analysis..."
# æ£€æŸ¥æž„å»ºäº§ç‰©çš„å®Œæ•´æ€§
for artifact_dir in artifacts/*/; do
if [[ -d "$artifact_dir" ]]; then
echo "Analyzing $(basename "$artifact_dir")..."
find "$artifact_dir" -name "*.exe" -o -name "*.dll" | wc -l
fi
done
# ç”Ÿæˆè´¨é‡æŠ¥å‘Š
echo "# Code Quality Report" > quality-report.md
echo "Generated: $(date)" >> quality-report.md
echo "" >> quality-report.md
echo "## Build Success Metrics" >> quality-report.md
echo "- **Total Artifacts:** $(find artifacts -type f | wc -l)" >> quality-report.md
echo "- **Successful Builds:** $(ls artifacts/ | wc -l)" >> quality-report.md
echo "" >> quality-report.md
echo "## Issues Fixed" >> quality-report.md
echo "- âœ… jom.exe path error resolved" >> quality-report.md
echo "- âœ… nmake build tool integration" >> quality-report.md
echo "- âœ… Enhanced error handling" >> quality-report.md
echo "- âœ… Artifact collection automation" >> quality-report.md
- name: Upload quality report
uses: actions/upload-artifact@v4
with:
name: Quality-Report-Enhanced
path: quality-report.md
